刷卡管理系统管理界面开发文档
1. 概述
本文档描述基于Streamlit库开发的刷卡管理系统管理界面。该管理界面将提供友好的操作面板，使管理员能够方便地管理IC卡信息、查看刷卡记录和分析使用统计数据。界面将直接与SQLite数据库交互，无需复杂的API层，适合在内网环境中使用。

1.1 技术栈
前端框架: Streamlit
数据库: SQLite (直接访问)
编程语言: Python 3.6+
可视化: Streamlit内置图表 + Plotly
1.2 系统功能
简单的账号密码登录
卡片信息管理（添加、编辑、删除、激活/禁用）
刷卡记录查询
失败记录查询
统计分析报表
部门管理
系统日志查看
2. 系统架构
2.1 整体架构
整个管理界面基于Streamlit开发，直接与SQLite数据库交互，不需要额外的API服务器。架构简洁，便于部署和维护。

[Streamlit Web界面] <---> [SQLite数据库]
                      |
                      v
                [读卡器服务器]
2.2 文件结构
ic_manager_admin/
├── app.py                 # 主应用入口
├── config.py              # 配置文件
├── database.py            # 数据库操作封装
├── utils.py               # 通用工具函数
├── pages/                 # 页面模块
│   ├── login.py           # 登录页面
│   ├── dashboard.py       # 控制面板
│   ├── card_management.py # 卡片管理
│   ├── records.py         # 刷卡记录
│   ├── statistics.py      # 统计分析
│   ├── department.py      # 部门管理
│   └── logs.py            # 系统日志
└── assets/                # 静态资源
    └── logo.png           # 系统Logo
3. 数据访问层
3.1 数据库连接
python
# database.py
import sqlite3
import pandas as pd

def get_db_connection():
    """获取数据库连接"""
    conn = sqlite3.connect('ic_manager.db')
    conn.row_factory = sqlite3.Row
    return conn

def query_to_dataframe(query, params=()):
    """执行查询并返回DataFrame"""
    conn = get_db_connection()
    df = pd.read_sql_query(query, conn, params=params)
    conn.close()
    return df

def execute_query(query, params=()):
    """执行更新操作"""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute(query, params)
    conn.commit()
    last_id = cursor.lastrowid
    conn.close()
    return last_id
3.2 主要数据操作函数
python
# 卡片管理函数
def get_cards(user=None, department=None, status=None):
    """获取卡片列表"""
    query = "SELECT * FROM kbk_ic_manager WHERE 1=1"
    params = []
    
    if user:
        query += " AND user LIKE ?"
        params.append(f'%{user}%')
    
    if department:
        query += " AND department LIKE ?"
        params.append(f'%{department}%')
    
    if status is not None:
        query += " AND status = ?"
        params.append(int(status))
    
    return query_to_dataframe(query, params)

def add_card(user, card, department, status=0):
    """添加新卡片"""
    query = "INSERT INTO kbk_ic_manager (user, card, department, status) VALUES (?, ?, ?, ?)"
    return execute_query(query, (user, card, department, status))

def update_card(card_id, user, department, status):
    """更新卡片信息"""
    query = "UPDATE kbk_ic_manager SET user = ?, department = ?, status = ? WHERE id = ?"
    return execute_query(query, (user, department, status, card_id))

def delete_card(card_id):
    """删除卡片"""
    query = "DELETE FROM kbk_ic_manager WHERE id = ?"
    return execute_query(query, (card_id,))

def update_card_status(card_id, status):
    """更新卡片状态"""
    query = "UPDATE kbk_ic_manager SET status = ? WHERE id = ?"
    return execute_query(query, (status, card_id))

# 记录查询函数
def get_records(table_name, start_date=None, end_date=None, user=None, department=None):
    """获取刷卡记录"""
    query = f"SELECT * FROM {table_name} WHERE 1=1"
    params = []
    
    if start_date:
        query += " AND transaction_date >= ?"
        params.append(start_date)
    
    if end_date:
        query += " AND transaction_date <= ?"
        params.append(end_date)
    
    if user:
        query += " AND user LIKE ?"
        params.append(f'%{user}%')
    
    if department:
        query += " AND department LIKE ?"
        params.append(f'%{department}%')
    
    query += " ORDER BY transaction_date DESC"
    
    return query_to_dataframe(query, params)

def get_failure_records(start_date=None, end_date=None, failure_type=None, user=None, department=None):
    """获取失败记录"""
    query = "SELECT * FROM kbk_ic_failure_records WHERE 1=1"
    params = []
    
    if start_date:
        query += " AND transaction_date >= ?"
        params.append(start_date)
    
    if end_date:
        query += " AND transaction_date <= ?"
        params.append(end_date)
    
    if failure_type is not None:
        query += " AND failure_type = ?"
        params.append(int(failure_type))
    
    if user:
        query += " AND user LIKE ?"
        params.append(f'%{user}%')
    
    if department:
        query += " AND department LIKE ?"
        params.append(f'%{department}%')
    
    query += " ORDER BY transaction_date DESC"
    
    return query_to_dataframe(query, params)

# 统计分析函数
def get_statistics(table_name, stat_type='daily', start_date=None, end_date=None, department=None):
    """获取统计数据"""
    time_format = {
        'daily': '%Y-%m-%d',
        'weekly': '%Y-%W',
        'monthly': '%Y-%m'
    }.get(stat_type, '%Y-%m-%d')
    
    query = f"""
    SELECT strftime('{time_format}', transaction_date) as period, COUNT(*) as count
    FROM {table_name}
    WHERE 1=1
    """
    params = []
    
    if start_date:
        query += " AND transaction_date >= ?"
        params.append(start_date)
    
    if end_date:
        query += " AND transaction_date <= ?"
        params.append(end_date)
    
    if department:
        query += " AND department LIKE ?"
        params.append(f'%{department}%')
    
    query += " GROUP BY period ORDER BY period"
    
    return query_to_dataframe(query, params)

# 部门管理函数
def get_departments():
    """获取部门列表"""
    query = "SELECT DISTINCT department FROM kbk_ic_manager ORDER BY department"
    return query_to_dataframe(query)

def add_department(department):
    """添加新部门（仅示例，实际可能需要创建新表）"""
    # 这里只是记录部门信息，您可能需要创建专门的部门表
    query = "INSERT INTO departments (name) VALUES (?)"
    return execute_query(query, (department,))
4. 页面设计
4.1 登录页面 (login.py)
python
# pages/login.py
import streamlit as st
import sqlite3
import hashlib

def show_login():
    st.title("刷卡管理系统登录")
    
    # 添加Logo
    # st.image("assets/logo.png", width=200)
    
    username = st.text_input("用户名")
    password = st.text_input("密码", type="password")
    
    if st.button("登录"):
        # 简单的账号密码校验（实际应用中应使用更安全的方式）
        if username == "admin" and password == "password":
            st.session_state.logged_in = True
            st.session_state.username = username
            st.success("登录成功！")
            st.experimental_rerun()
        else:
            st.error("用户名或密码错误")
4.2 控制面板 (dashboard.py)
python
# pages/dashboard.py
import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime, timedelta
from database import get_statistics, get_cards, get_failure_records

def show_dashboard():
    st.title("控制面板")
    
    # 获取基本统计信息
    cards_df = get_cards()
    active_cards = len(cards_df[cards_df['status'] == 1])
    total_cards = len(cards_df)
    
    # 获取今日数据
    today = datetime.now().strftime("%Y-%m-%d")
    cn_today = get_statistics('kbk_ic_cn_count', start_date=today)
    en_today = get_statistics('kbk_ic_en_count', start_date=today)
    nm_today = get_statistics('kbk_ic_nm_count', start_date=today)
    
    # 计算今日总刷卡数
    today_total = 0
    if not cn_today.empty and 'count' in cn_today.columns:
        today_total += cn_today['count'].sum()
    if not en_today.empty and 'count' in en_today.columns:
        today_total += en_today['count'].sum()
    if not nm_today.empty and 'count' in nm_today.columns:
        today_total += nm_today['count'].sum()
    
    # 展示统计卡片
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("总卡片数", f"{total_cards}")
    with col2:
        st.metric("已激活卡片", f"{active_cards}")
    with col3:
        st.metric("今日刷卡数", f"{today_total}")
    with col4:
        # 失败记录
        failures = get_failure_records(start_date=today)
        st.metric("今日失败数", f"{len(failures)}")
    
    # 近期刷卡趋势
    st.subheader("近30天刷卡趋势")
    
    # 获取近30天数据
    thirty_days_ago = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
    cn_stats = get_statistics('kbk_ic_cn_count', start_date=thirty_days_ago)
    en_stats = get_statistics('kbk_ic_en_count', start_date=thirty_days_ago)
    nm_stats = get_statistics('kbk_ic_nm_count', start_date=thirty_days_ago)
    
    # 合并数据
    if not cn_stats.empty:
        cn_stats = cn_stats.rename(columns={'count': '中文刷卡'})
    if not en_stats.empty:
        en_stats = en_stats.rename(columns={'count': '英文刷卡'})
    if not nm_stats.empty:
        nm_stats = nm_stats.rename(columns={'count': '其他刷卡'})
    
    # 合并为一个DataFrame
    merged_stats = pd.DataFrame()
    merged_stats['日期'] = pd.date_range(end=datetime.now(), periods=30).strftime("%Y-%m-%d")
    merged_stats = merged_stats.set_index('日期')
    
    if not cn_stats.empty:
        cn_stats = cn_stats.set_index('period')
        merged_stats = merged_stats.join(cn_stats, how='left')
    if not en_stats.empty:
        en_stats = en_stats.set_index('period')
        merged_stats = merged_stats.join(en_stats, how='left')
    if not nm_stats.empty:
        nm_stats = nm_stats.set_index('period')
        merged_stats = merged_stats.join(nm_stats, how='left')
    
    merged_stats = merged_stats.fillna(0).reset_index()
    
    # 绘制折线图
    if not merged_stats.empty and len(merged_stats.columns) > 1:
        fig = px.line(merged_stats, x='日期', y=merged_stats.columns[1:])
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("暂无刷卡数据")
    
    # 部门分布
    st.subheader("部门分布")
    
    if not cards_df.empty:
        dept_counts = cards_df['department'].value_counts().reset_index()
        dept_counts.columns = ['部门', '卡片数']
        
        fig = px.pie(dept_counts, values='卡片数', names='部门')
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("暂无部门数据")
4.3 卡片管理页面 (card_management.py)
python
# pages/card_management.py
import streamlit as st
import pandas as pd
from database import get_cards, add_card, update_card, delete_card, update_card_status

def show_card_management():
    st.title("卡片管理")
    
    # 创建选项卡
    tab1, tab2 = st.tabs(["卡片列表", "添加卡片"])
    
    # 卡片列表选项卡
    with tab1:
        st.subheader("卡片列表")
        
        # 搜索过滤
        col1, col2, col3 = st.columns(3)
        with col1:
            user_filter = st.text_input("按用户名筛选")
        with col2:
            dept_filter = st.text_input("按部门筛选")
        with col3:
            status_filter = st.selectbox("卡片状态", options=[None, 1, 0], format_func=lambda x: "全部" if x is None else ("激活" if x == 1 else "禁用"))
        
        # 获取卡片列表
        cards_df = get_cards(user=user_filter, department=dept_filter, status=status_filter)
        
        if not cards_df.empty:
            # 添加操作列
            cards_df['操作'] = False  # 为每行添加一个编辑按钮的占位符
            cards_df['status_display'] = cards_df['status'].map({1: '激活', 0: '禁用'})
            
            # 显示卡片列表
            edited_df = st.data_editor(
                cards_df[['id', 'user', 'card', 'department', 'status_display', '操作']],
                column_config={
                    "id": "ID",
                    "user": "用户名",
                    "card": "卡号",
                    "department": "部门",
                    "status_display": "状态",
                    "操作": st.column_config.CheckboxColumn("选择", default=False)
                },
                hide_index=True,
                key="card_table"
            )
            
            # 获取选中的行
            selected_rows = edited_df[edited_df['操作'] == True]
            
            if not selected_rows.empty:
                selected_id = selected_rows.iloc[0]['id']
                
                # 显示编辑表单
                st.subheader(f"编辑卡片 #{selected_id}")
                
                # 获取当前卡信息
                current_card = cards_df[cards_df['id'] == selected_id].iloc[0]
                
                col1, col2 = st.columns(2)
                with col1:
                    edit_user = st.text_input("用户名", value=current_card['user'])
                    edit_department = st.text_input("部门", value=current_card['department'])
                with col2:
                    edit_card = st.text_input("卡号", value=current_card['card'], disabled=True)
                    edit_status = st.selectbox("状态", options=[1, 0], format_func=lambda x: "激活" if x == 1 else "禁用", index=current_card['status'])
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    if st.button("更新卡片", type="primary"):
                        update_card(selected_id, edit_user, edit_department, edit_status)
                        st.success("卡片信息已更新")
                        st.experimental_rerun()
                with col2:
                    if st.button("删除卡片", type="secondary"):
                        delete_card(selected_id)
                        st.success("卡片已删除")
                        st.experimental_rerun()
                with col3:
                    # 快速激活/禁用按钮
                    new_status = 1 if current_card['status'] == 0 else 0
                    button_text = "激活卡片" if new_status == 1 else "禁用卡片"
                    if st.button(button_text):
                        update_card_status(selected_id, new_status)
                        st.success(f"卡片已{'激活' if new_status == 1 else '禁用'}")
                        st.experimental_rerun()
        else:
            st.info("未找到卡片信息")
    
    # 添加卡片选项卡
    with tab2:
        st.subheader("添加新卡片")
        
        col1, col2 = st.columns(2)
        with col1:
            new_user = st.text_input("用户名", key="new_user")
            new_department = st.text_input("部门", key="new_dept")
        with col2:
            new_card = st.text_input("卡号", key="new_card")
            new_status = st.selectbox("状态", options=[1, 0], format_func=lambda x: "激活" if x == 1 else "禁用", key="new_status")
        
        if st.button("添加卡片", key="add_card_btn"):
            if new_user and new_card and new_department:
                try:
                    add_card(new_user, new_card, new_department, new_status)
                    st.success("卡片添加成功")
                    # 清空输入
                    st.session_state.new_user = ""
                    st.session_state.new_card = ""
                    st.session_state.new_dept = ""
                except Exception as e:
                    st.error(f"添加失败: {str(e)}")
            else:
                st.warning("请填写所有必填字段")
        
        # 批量导入部分
        st.subheader("批量导入卡片")
        upload_file = st.file_uploader("上传CSV或Excel文件", type=['csv', 'xlsx'])
        
        if upload_file is not None:
            try:
                if upload_file.name.endswith('.csv'):
                    df = pd.read_csv(upload_file)
                else:
                    df = pd.read_excel(upload_file)
                
                # 显示预览
                st.subheader("数据预览")
                st.dataframe(df.head())
                
                # 字段映射
                st.subheader("字段映射")
                cols = df.columns.tolist()
                
                user_col = st.selectbox("选择用户名字段", options=cols)
                card_col = st.selectbox("选择卡号字段", options=cols)
                dept_col = st.selectbox("选择部门字段", options=cols)
                
                if st.button("导入数据"):
                    success_count = 0
                    error_count = 0
                    
                    for _, row in df.iterrows():
                        try:
                            # 使用默认激活状态1
                            add_card(row[user_col], row[card_col], row[dept_col], 1)
                            success_count += 1
                        except Exception:
                            error_count += 1
                    
                    st.success(f"导入完成: 成功{success_count}条, 失败{error_count}条")
            except Exception as e:
                st.error(f"文件处理错误: {str(e)}")
4.4 刷卡记录页面 (records.py)
python
# pages/records.py
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
from database import get_records, get_failure_records

def show_records():
    st.title("刷卡记录查询")
    
    # 创建选项卡
    tab1, tab2, tab3, tab4 = st.tabs(["中文记录", "英文记录", "其他记录", "失败记录"])
    
    # 设置通用的日期筛选组件
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        start_date = st.date_input("开始日期", datetime.now() - timedelta(days=7))
    with col2:
        end_date = st.date_input("结束日期", datetime.now())
    with col3:
        user_filter = st.text_input("用户名", key="record_user")
    with col4:
        dept_filter = st.text_input("部门", key="record_dept")
    
    # 转换日期格式
    start_date_str = start_date.strftime("%Y-%m-%d")
    end_date_str = end_date.strftime("%Y-%m-%d")
    
    # 中文记录选项卡
    with tab1:
        st.subheader("中文刷卡记录")
        cn_records = get_records('kbk_ic_cn_count', start_date_str, end_date_str, user_filter, dept_filter)
        
        if not cn_records.empty:
            st.dataframe(
                cn_records,
                column_config={
                    "id": "ID",
                    "user": "用户名",
                    "department": "部门",
                    "transaction_date": "刷卡时间"
                },
                hide_index=True
            )
            
            # 导出功能
            csv = cn_records.to_csv(index=False).encode('utf-8')
            st.download_button(
                "导出CSV",
                csv,
                "中文刷卡记录.csv",
                "text/csv",
                key='cn_export'
            )
        else:
            st.info("暂无记录")
    
    # 英文记录选项卡
    with tab2:
        st.subheader("英文刷卡记录")
        en_records = get_records('kbk_ic_en_count', start_date_str, end_date_str, user_filter, dept_filter)
        
        if not en_records.empty:
            st.dataframe(
                en_records,
                column_config={
                    "id": "ID",
                    "user": "用户名",
                    "department": "部门",
                    "transaction_date": "刷卡时间"
                },
                hide_index=True
            )
            
            # 导出功能
            csv = en_records.to_csv(index=False).encode('utf-8')
            st.download_button(
                "导出CSV",
                csv,
                "英文刷卡记录.csv",
                "text/csv",
                key='en_export'
            )
        else:
            st.info("暂无记录")
    
    # 其他记录选项卡
    with tab3:
        st.subheader("其他语言刷卡记录")
        nm_records = get_records('kbk_ic_nm_count', start_date_str, end_date_str, user_filter, dept_filter)
        
        if not nm_records.empty:
            st.dataframe(
                nm_records,
                column_config={
                    "id": "ID",
                    "user": "用户名",
                    "department": "部门",
                    "transaction_date": "刷卡时间"
                },
                hide_index=True
            )
            
            # 导出功能
            csv = nm_records.to_csv(index=False).encode('utf-8')
            st.download_button(
                "导出CSV",
                csv,
                "其他刷卡记录.csv",
                "text/csv",
                key='nm_export'
            )
        else:
            st.info("暂无记录")
    
    # 失败记录选项卡
    with tab4:
        st.subheader("刷卡失败记录")
        
        # 失败类型过滤
        failure_type = st.selectbox(
            "失败类型", 
            options=[None, 1, 2], 
            format_func=lambda x: "全部" if x is None else ("未激活" if x == 1 else "卡号不存在"),
            key="failure_type"
        )
        
        failure_records = get_failure_records(start_date_str, end_date_str, failure_type, user_filter, dept_filter)
        
        if not failure_records.empty:
            # 添加可读的失败类型
            failure_records['failure_type_desc'] = failure_records['failure_type'].map({1: '未激活', 2: '卡号不存在'})
            
            st.dataframe(
                failure_records,
                column_config={
                    "id": "ID",
                    "user": "用户名",
                    "department": "部门",
                    "transaction_date": "刷卡时间",
                    "failure_type_desc": "失败原因"
                },
                hide_index=True
            )
            
            # 导出功能
            csv = failure_records.to_csv(index=False).encode('utf-8')
            st.download_button(
                "导出CSV",
                csv,
                "失败记录.csv",
                "text/csv",
                key='failure_export'
            )
        else:
            st.info("暂无记录")
4.5 统计分析页面 (statistics.py)
python
# pages/statistics.py
import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime, timedelta
from database import get_statistics, get_departments

def show_statistics():
    st.title("统计分析")
    
    # 筛选条件
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        start_date = st.date_input("开始日期", datetime.now() - timedelta(days=30))
    with col2:
        end_date = st.date_input("结束日期", datetime.now())
    with col3:
        # 获取所有部门
        departments = get_departments()
        dept_options = ["全部"] + departments['department'].tolist() if not departments.empty else ["全部"]
        selected_dept = st.selectbox("选择部门", options=dept_options)
    with col4:
        stat_type = st.selectbox("统计周期", options=['daily', 'weekly', 'monthly'], 
                               format_func=lambda x: {'daily': '日', 'weekly': '周', 'monthly': '月'}[x])
    
    # 转换日期格式
    start_date_str = start_date.strftime("%Y-%m-%d")
    end_date_str = end_date.strftime("%Y-%m-%d")
    
    # 部门参数处理
    dept_param = None if selected_dept == "全部" else selected_dept
    
    # 获取统计数据
    cn_stats = get_statistics('kbk_ic_cn_count', stat_type, start_date_str, end_date_str, dept_param)
    en_stats = get_statistics('kbk_ic_en_count', stat_type, start_date_str, end_date_str, dept_param)
    nm_stats = get_statistics('kbk_ic_nm_count', stat_type, start_date_str, end_date_str, dept_param)
    
    # 准备图表数据
    if not cn_stats.empty:
        cn_stats = cn_stats.rename(columns={'count': '中文刷卡'})
    if not en_stats.empty:
        en_stats = en_stats.rename(columns={'count': '英文刷卡'})
    if not nm_stats.empty:
        nm_stats = nm_stats.rename(columns={'count': '其他刷卡'})
    
    # 合并数据集
    stats_dfs = []
    period_label = {'daily': '日期', 'weekly': '周', 'monthly': '月份'}[stat_type]
    
    if not cn_stats.empty:
        cn_stats = cn_stats.rename(columns={'period': period_label})
        stats_dfs.append(cn_stats)
    if not en_stats.empty:
        en_stats = en_stats.rename(columns={'period': period_label})
        stats_dfs.append(en_stats)
    if not nm_stats.empty:
        nm_stats = nm_stats.rename(columns={'period': period_label})
        stats_dfs.append(nm_stats)
    
    merged_df = pd.DataFrame()
    if stats_dfs:
        # 合并所有数据
        for i, df in enumerate(stats_dfs):
            if i == 0:
                merged_df = df
            else:
                merged_df = pd.merge(merged_df, df, on=period_label, how='outer')
        
        merged_df = merged_df.fillna(0)
    
    # 绘制图表
    if not merged_df.empty:
        st.subheader("刷卡趋势")
        
        # 折线图
        fig1 = px.line(merged_df, x=period_label, y=merged_df.columns[1:])
        st.plotly_chart(fig1, use_container_width=True)
        
        # 柱状图
        fig2 = px.bar(merged_df, x=period_label, y=merged_df.columns[1:], barmode='group')
        st.plotly_chart(fig2, use_container_width=True)
        
        # 统计数据表格
        st.subheader("统计数据表")
        st.dataframe(merged_df)
        
        # 导出功能
        csv = merged_df.to_csv(index=False).encode('utf-8')
        st.download_button(
            "导出CSV",
            csv,
            "刷卡统计数据.csv",
            "text/csv",
            key='stats_export'
        )
    else:
        st.info("所选时间范围内无刷卡数据")
    
    # 部门分析（如果未选择特定部门）
    if selected_dept == "全部":
        st.subheader("部门刷卡分布")
        
        # 获取部门数据
        dept_stats_cn = get_department_stats('kbk_ic_cn_count', start_date_str, end_date_str)
        dept_stats_en = get_department_stats('kbk_ic_en_count', start_date_str, end_date_str)
        dept_stats_nm = get_department_stats('kbk_ic_nm_count', start_date_str, end_date_str)
        
        # 合并部门数据
        dept_merged = pd.DataFrame()
        if not dept_stats_cn.empty:
            dept_stats_cn = dept_stats_cn.rename(columns={'count': '中文刷卡'})
            dept_merged = dept_stats_cn
        
        if not dept_stats_en.empty:
            dept_stats_en = dept_stats_en.rename(columns={'count': '英文刷卡'})
            if dept_merged.empty:
                dept_merged = dept_stats_en
            else:
                dept_merged = pd.merge(dept_merged, dept_stats_en, on='department', how='outer')
        
        if not dept_stats_nm.empty:
            dept_stats_nm = dept_stats_nm.rename(columns={'count': '其他刷卡'})
            if dept_merged.empty:
                dept_merged = dept_stats_nm
            else:
                dept_merged = pd.merge(dept_merged, dept_stats_nm, on='department', how='outer')
        
        dept_merged = dept_merged.fillna(0)
        
        if not dept_merged.empty:
            # 计算总刷卡数
            cols = [col for col in dept_merged.columns if col != 'department']
            dept_merged['总刷卡数'] = dept_merged[cols].sum(axis=1)
            
            # 部门刷卡柱状图
            fig3 = px.bar(dept_merged, x='department', y='总刷卡数', title="各部门刷卡总数")
            st.plotly_chart(fig3, use_container_width=True)
            
            # 部门分类饼图
            fig4 = px.pie(dept_merged, values='总刷卡数', names='department', title="各部门刷卡占比")
            st.plotly_chart(fig4, use_container_width=True)
            
            # 部门详细数据
            st.dataframe(dept_merged)
        else:
            st.info("所选时间范围内无部门刷卡数据")

# 获取部门统计数据函数（需添加到database.py）
def get_department_stats(table_name, start_date=None, end_date=None):
    """获取部门统计数据"""
    query = f"""
    SELECT department, COUNT(*) as count
    FROM {table_name}
    WHERE 1=1
    """
    params = []
    
    if start_date:
        query += " AND transaction_date >= ?"
        params.append(start_date)
    
    if end_date:
        query += " AND transaction_date <= ?"
        params.append(end_date)
    
    query += " GROUP BY department ORDER BY count DESC"
    
    return query_to_dataframe(query, params)
